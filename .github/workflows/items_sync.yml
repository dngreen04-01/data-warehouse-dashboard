name: Items Inventory Sync

on:
  schedule:
    # Run at 12:00 UTC daily (approximately 1:00 AM NZT)
    - cron: '0 12 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  sync-items:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Items Sync with Retry
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        retry_wait_seconds: 60
        command: python -m src.ingestion.sync_items
      env:
        SUPABASE_CONNECTION_STRING: ${{ secrets.SUPABASE_CONNECTION_STRING }}
        XERO_CLIENT_ID: ${{ secrets.XERO_CLIENT_ID }}
        XERO_CLIENT_SECRET: ${{ secrets.XERO_CLIENT_SECRET }}
        XERO_TENANT_ID: ${{ secrets.XERO_TENANT_ID }}
        XERO_ENCRYPTION_KEY: ${{ secrets.XERO_ENCRYPTION_KEY }}

    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue_body = `### Items Sync Failure Alert

          **Workflow:** ${context.workflow}
          **Run ID:** ${context.runId}
          **Run URL:** https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          **Branch:** ${context.ref}
          **Triggered by:** ${context.eventName}
          **Timestamp:** ${new Date().toISOString()}

          #### Possible Causes:
          - Xero access token expired (401 error)
          - Missing accounting.settings.read scope
          - Network connectivity issues
          - Database connection failure

          #### Action Required:
          1. Check the workflow logs for detailed error messages
          2. Check dw.etl_run_log table for application logs
          3. Verify Xero app has required scopes

          **Auto-generated by GitHub Actions**`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Items Sync Failed - ${new Date().toISOString().split('T')[0]}`,
            body: issue_body,
            labels: ['automated-alert', 'sync-failure', 'high-priority']
          });

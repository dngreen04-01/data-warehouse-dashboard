name: Daily Data Sync

on:
  schedule:
    # Run at 6:00 AM UTC daily
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Increased to account for potential retries
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Run Xero Sync with Retry
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 60
        command: python -m src.ingestion.sync_xero
      env:
        SUPABASE_CONNECTION_STRING: ${{ secrets.SUPABASE_CONNECTION_STRING }}
        XERO_CLIENT_ID: ${{ secrets.XERO_CLIENT_ID }}
        XERO_CLIENT_SECRET: ${{ secrets.XERO_CLIENT_SECRET }}
        XERO_TENANT_ID: ${{ secrets.XERO_TENANT_ID }}
        XERO_ENCRYPTION_KEY: ${{ secrets.XERO_ENCRYPTION_KEY }}

    - name: Run Budget Sync
      # Run budgets only if Xero sync succeeds (default behavior of steps)
      run: |
        python -m src.ingestion.sync_budgets
      env:
        SUPABASE_CONNECTION_STRING: ${{ secrets.SUPABASE_CONNECTION_STRING }}
        XERO_CLIENT_ID: ${{ secrets.XERO_CLIENT_ID }}
        XERO_CLIENT_SECRET: ${{ secrets.XERO_CLIENT_SECRET }}
        XERO_TENANT_ID: ${{ secrets.XERO_TENANT_ID }}
        # Budgets might not strictly need encryption key if it doesn't use token storage the same way, 
        # but good to have if it initializes the same client class.
        XERO_ENCRYPTION_KEY: ${{ secrets.XERO_ENCRYPTION_KEY }}

    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const issue_body = `### Data Sync Failure Alert

          **Workflow:** ${context.workflow}
          **Run ID:** ${context.runId}
          **Run URL:** https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          **Branch:** ${context.ref}
          **Triggered by:** ${context.eventName}
          **Timestamp:** ${new Date().toISOString()}

          #### Possible Causes:
          - Xero refresh token expired (401 error)
          - Network connectivity issues
          - Database connection failure
          - API rate limits

          #### Action Required:
          1. Check the workflow logs for detailed error messages
          2. Check dw.etl_run_log table for application logs

          **Auto-generated by GitHub Actions**`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Daily Sync Failed - ${new Date().toISOString().split('T')[0]}`,
            body: issue_body,
            labels: ['automated-alert', 'sync-failure', 'high-priority']
          });
